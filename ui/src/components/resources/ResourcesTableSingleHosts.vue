<template>
  <v-container fluid>
    <v-row
      dense
      class="ml-8 mb-8"
      align="center"
    >
      <v-text-field
        v-model="searchResources"
        label="Search resources"
        append-inner-icon="mdi-magnify"
        clearable
        variant="underlined"
      />
      <v-spacer />
      <v-spacer />
      <v-tooltip
        start
        close-delay="2000"
      >
        <template #activator="{ props }">
          <v-btn
            v-if="profiler.length > 0"
            color="secondary"
            v-bind="props"
            @click="runProfiler"
          >
            <v-icon
              icon="mdi-tab-search"
              color="white"
            />
          </v-btn>
        </template>
        <span>Run all available <a href="https://eclipse-slm.github.io/slm/docs/usage/profiler/">profilers</a> on all devices</span>
      </v-tooltip>
      <div v-if="resourcesHaveLocations()">
        <div class="mr-10">
          <v-btn-toggle
            v-model="groupBy"
            mandatory
          >
            <v-btn
              size="small"
              :model-value="null"
              :color="groupBy == null ? 'secondary' : 'disabled'"
              style="height:40px"
            >
              <v-icon>mdi-ungroup</v-icon>
            </v-btn>
            <v-btn
              size="small"
              model-value="location.name"
              :color="groupBy === 'location.name' ? 'secondary' : 'disabled'"
              style="height:40px"
            >
              <v-icon>mdi-group</v-icon>
            </v-btn>
          </v-btn-toggle>
        </div>
        <div class="mr-10">
          <v-select
            v-model="filterResourcesByLocations"
            :items="locations"
            item-title="name"
            item-value="id"
            label="filter by location"
            density="compact"
            variant="outlined"
            hide-details
            closable-chips
            multiple
            clearable
            @update:modelValue="filterResources"
          />
        </div>
      </div>
    </v-row>
    <v-data-table
      id="resource-table-single-host"
      :headers="tableHeaders"
      :items="filteredResources"
      :search="searchResources"
      :sort-by.sync="sortBy"
      :row-props="rowClass"
      item-key="id"

      @click:row="setSelectedResource"
    >
      <template #group.header="{items, isOpen, toggle}">
        <th
          :colspan="tableHeaders.length"
        >
          <v-icon @click="toggle">
            {{ isOpen ? 'mdi-minus' : 'mdi-plus' }}
          </v-icon>
          {{ getLocationNameForGroupHeader(items) }}
        </th>
      </template>

      <template #item.product="{ item }">
        {{ resourceStore.getSubmodelElementValueOfResourceSubmodel(item.id, "Nameplate", "$.ManufacturerProductType..en") }}
      </template>

      <template #item.vendor="{ item }">
        {{ resourceStore.getSubmodelElementValueOfResourceSubmodel(item.id, "Nameplate", "$.ManufacturerName..en") }}
      </template>

      <template #item.capabilityServices="{ item }">
        <v-tooltip
          v-for="capabilityService in getDeploymentCapabilityServices(item.capabilityServices)"
          :key="capabilityService.capability.name"
          location="top"
        >
          <template
            #activator="{ props }"
          >
            <v-chip
              v-bind="props"
              :key="capabilityService.capability.name"
              class="ma-1"
            >
              <v-icon start>
                {{ getChipIconByCapabilityService(capabilityService) }}
              </v-icon>
              {{ capabilityService.capability.name }}
            </v-chip>
          </template>
          <span>Status: {{ capabilityService.status }}</span>
        </v-tooltip>
      </template>

      <template #item.firmware="{ item }">
        {{ resourceStore.getSubmodelElementValueOfResourceSubmodel(item.id, "Nameplate", "$.FirmwareVersion") }}
      </template>

      <!-- Column: Actions -->
      <template
        #item.actions="{ item }"
      >
        <div
          v-if="!item.markedForDelete"
          class="text-right btn-col"
        >
          <v-menu>
            <template #activator="{ props }">
              <v-btn
                id="mushroom-button"
                color="info"
                v-bind="props"
                :disabled="item.clusterMember || availableSingleHostCapabilitiesNoDefault.length === 0"
                class="resource-single-host-add-capability"
              >
                <v-icon
                  color="white"
                  icon="mdi-mushroom-outline"
                />
              </v-btn>
            </template>
            <v-list>
              <v-list
                v-for="capabilityClass in getUniqueCapabilityClasses"
                :key="capabilityClass"
                class="resources-capability-menu"
              >
                <h6 class="ml-4">
                  {{ insertWhiteSpaceInCamelCase(capabilityClass) }}
                </h6>
                <v-list-item
                  v-for="capability in getCapabilitiesByCapabilityClass(capabilityClass)"
                  :key="capability.id"
                >
                  <v-btn-toggle>
                    <!-- Capability Install Button -->
                    <v-btn
                      v-if="showCapabilityInstallButton(item, capability)"
                      id="install-button"
                      :disabled="!resourceHasRemoteAccessService(item)"
                      class="bg-info"
                      style="height:36px"
                      :prepend-icon="capability.logo"
                      @click="openDefineCapabilityParamsDialog(item.id, capability.id, false)"
                    >
                      {{ capability.name }}
                    </v-btn>
                    <!-- Capability Skip Install Button -->
                    <v-btn
                      v-if="showCapabilitySkipInstallButton(item,capability)"
                      class="bg-info"
                      style="height:36px"
                      @click="openDefineCapabilityParamsDialog(item.id, capability.id, true)"
                    >
                      <v-icon icon="mdi-skip-next" />
                    </v-btn>
                    <!-- Capability Uninstall Button -->
                    <v-btn
                      v-if="isCapabilityInstalledOnResource(item, capability)"
                      color="error"
                      class="bg-error"
                      style="height:36px"
                      :append-icon="capability.logo"
                      @click="removeCapability(item.id, capability.id)"
                    >
                      {{ capability.name }}
                    </v-btn>
                  </v-btn-toggle>
                </v-list-item>
              </v-list>
            </v-list>
          </v-menu>
          <v-btn
            :disabled="item.clusterMember"
            class="ma-2 resource-single-host-delete"
            color="error"
            @click.stop="resourceToDelete = item"
          >
            <v-icon icon="mdi-delete" />
          </v-btn>
        </div>
      </template>
    </v-data-table>
    <confirm-dialog
      :show="resourceToDelete != null"
      :title="'Delete resource ' + (resourceToDelete == null ? '' : resourceToDelete.hostname)"
      text="Do you really want to delete this resource?"
      @confirmed="deleteResource(resourceToDelete)"
      @canceled="resourceToDelete = null"
    />
    <capability-params-dialog
      :show-dialog="showCapabilityParamsDialog"
      :capability-id="selectedCapabilityId"
      :resource-id="selectedResourceId"
      :skip-install="selectedSkipInstall"
      @install="runAddCapability"
      @canceled="unsetSelected()"
    />
  </v-container>
</template>

<script>

import ConfirmDialog from '@/components/base/ConfirmDialog'
import CapabilityParamsDialog from "@/components/resources/dialogs/CapabilityParamsDialog.vue";
import {capabilityUtilsMixin} from '@/utils/capabilityUtils'
import {app} from "@/main";
import {useResourcesStore} from "@/stores/resourcesStore";
import ResourceManagementClient from "@/api/resource-management/resource-management-client";
import logRequestError from "@/api/restApiHelper";

export default {
    name: 'ResourcesTableSingleHosts',
    components: {CapabilityParamsDialog, ConfirmDialog },
    mixins: [capabilityUtilsMixin],
    setup(){
      const resourceStore = useResourcesStore();
      return {resourceStore};
    },
    data () {
      return {
        tableHeaders: [
          { title: "Product", key: "product" },
          { title: "Vendor", key: "vendor" },
          { title: 'Capabilities', key: 'capabilityServices', value: 'capabilityServices' },
          { title: 'Hostname', key: 'hostname', value: 'hostname' },
          { title: 'IP', key: 'ip', value: 'ip' },
          { title: 'Location', key: 'location.name', value: 'location.name'},
          { title: 'Firmware', key: 'firmware' },
          { title: 'Actions', value: 'actions', sortable: false },
        ],
        groupBy: [],
        sortBy: [{key: 'ip', order: 'asc'}],
        sortDesc: false,
        showLvlUpMenu: false,
        showResourcesDeleteDialog: false,
        resourceToDelete: null,
        resourceMetrics: {},
        selectedResourceId: null,
        selectedCapabilityId: null,
        selectedSkipInstall: null,
        selectedParamMap: null,
        filterResourcesByLocations: [],
        filteredResources: [],
        searchResources: undefined
      }
    },
    computed: {
      resources () {
        return this.resourceStore.resources
      },
      locations() {
        return this.resourceStore.locations
      },
      profiler() {
        return this.resourceStore.profiler
      },
      selectedResourceForDelete () {
        return this.resourceStore.selectedResourceForDelete
      },
      availableSingleHostCapabilitiesNoDefault() {
        return this.resourceStore.availableSingleHostCapabilitiesNoDefault
      },
      showCapabilityParamsDialog() {
        if(this.selectedResourceId !== null && this.selectedCapabilityId !== null && this.selectedSkipInstall !== null)
          return true
        else
          return false
      },
      getUniqueCapabilityClasses() {
        return [...new Set(
          this.availableSingleHostCapabilitiesNoDefault.map(shc => shc.capabilityClass)
        )].sort()
      }
    },
    watch: {
      resources() {
        this.filterResources()
      }
    },
  mounted () {
    this.resourceStore.getResourceAasValues()
  },
    created() {
      this.filteredResources = this.resources
      this.resourceStore.getResourceAasValues()
    },
    methods: {
      getDeploymentCapabilityServices(capabilityServices) {
        return capabilityServices.filter(cs => cs.capability.capabilityClass!=="BaseConfigurationCapability")
      },
      deleteResource (resource) {
        const resourceId = resource.id
        ResourceManagementClient.resourcesApi.deleteResource(resourceId).then();
        this.resourceStore.setResourceMarkedForDelete(resource);
        this.resourceToDelete = null
      },
      openDefineCapabilityParamsDialog(resourceId, capabilityId, skipInstall) {
        if(this.isDefineCapabilityDialogRequired(capabilityId, skipInstall) === false) {
          this.addCapability(resourceId,capabilityId,skipInstall,{})
          return;
        }

        this.selectedResourceId = resourceId
        this.selectedCapabilityId = capabilityId
        this.selectedSkipInstall = skipInstall
      },
      runAddCapability(configParameter) {
        this.addCapability(this.selectedResourceId, this.selectedCapabilityId, this.selectedSkipInstall, configParameter)
      },
      addCapability (resourceId, capabilityId, skipInstall, configParameterMap) {
        ResourceManagementClient.capabilityApi.installCapabilityOnSingleHost(resourceId, capabilityId, configParameterMap, skipInstall).then();
        this.unsetSelected()
      },
      unsetSelected() {
        this.selectedResourceId = null
        this.selectedCapabilityId = null
        this.selectedSkipInstall = null
        this.selectedParamMap = null
      },
      hasCapabilityConfigParamsWithRequiredTypeAlways(capabilityId) {
        if(this.getCapability(capabilityId).actions["INSTALL"].configParameters === undefined)
          return false

        return this.getCapability(capabilityId).actions["INSTALL"].configParameters.filter(
          param => param.requiredType === "ALWAYS"
        ).length !== 0
      },
      isDefineCapabilityDialogRequired(capabilityId, skipInstall) {
        //false
        if(this.getParamsOfInstallAction(capabilityId).length === 0)
          return false
        else if (this.hasCapabilityConfigParamsWithRequiredTypeAlways(capabilityId) === false && skipInstall === true)
          return false
        else
          return true
      },
      removeCapability (resourceId, capabilityId) {
        ResourceManagementClient.capabilityApi.removeCapabilityFromSingleHost(resourceId, capabilityId)
            .then().catch(logRequestError);

      },
      setSelectedResource (event, { item }) {
        this.$emit('resource-selected', item)
      },
      rowClass (resource) {
        return {
          class: {
            'text-grey text--lighten-1 row-pointer': resource.markedForDelete,
            'row-pointer': resource.markedForDelete
          }
        }
      },
      isCapabilityInstalledOnResource (resource, capability) {
        if(resource.capabilityServices !== null)
          return resource.capabilityServices.filter(capService => capService.capability.name === capability.name).length > 0
        else
          return false
      },
      isCapabilitySkipable(capability) {
        const installAction = capability.actions["INSTALL"]
        if(installAction !== undefined && installAction.skipable !== undefined)
          return installAction.skipable
        else
          return false
      },
      showCapabilityInstallButton(resource, capability) {
        return !this.isCapabilityInstalledOnResource(resource,capability)
      },
      showCapabilitySkipInstallButton(resource, capability) {
        return !this.isCapabilityInstalledOnResource(resource,capability) && this.isCapabilitySkipable(capability)
      },
      showCapabilityUninstallButton(resource, capability) {
        return this.isCapabilityInstalledOnResource(resource,capability)
      },
      getChipIconByCapabilityService(capabilityService) {
        const status = capabilityService.status

        if(status === "READY")
          return "mdi-check"

        if(status === "INSTALL")
          return "mdi-plus"

        if(status === "UNINSTALL")
          return "mdi-minus"

        if(status === "UNKNOWN")
          return "mdi-help"

        if(status === "FAILED")
          return "mdi-alert-circle-outline"

      },
      getOsIcon(remoteAccessService) {
        let conType
        try {
          conType = remoteAccessService.connectionType
        } catch(e) {
          conType = null
        }


        if(conType === "ssh")
          return "mdi-penguin"
        if(conType === "WinRM" || conType === "WinSsh")
          return "mdi-microsoft-windows"
        else
          return "mdi-help-circle-outline"
      },
      getLocationNameForGroupHeader(items) {
        if(items[0].location === null)
          return "no location"

        return items[0].location.name
      },
      resourcesHaveLocations() {
        const locationNames = [...new Set(
          this.resources.map(r => {
            if(r.location == null)
              return ''
            else
              return r.location.name
          })
        )]
        const hasLocations = locationNames.length > 1

        if(!hasLocations)
          this.groupBy = null

        return hasLocations
      },
      filterResources() {
        if(this.filterResourcesByLocations.length === 0) {
          this.filteredResources = this.resources
          return
        }

        this.filteredResources = this.resources.filter(r => {
          if(r.location == null)
            return false

          return this.filterResourcesByLocations.includes( r.location.id )
        })
      },
      resourceHasRemoteAccessService(resource) {
        return resource.remoteAccessService != null
      },
      getCapabilitiesByCapabilityClass(capabilityClass) {
        return this.availableSingleHostCapabilitiesNoDefault.filter(shc => shc.capabilityClass === capabilityClass)
      },
      insertWhiteSpaceInCamelCase(string) {
        return string.replace(/([A-Z])/g, ' $1').trim()
      },
      runProfiler() {
        ResourceManagementClient.profilerApi.runProfiler1().then().catch(logRequestError);
        app.config.globalProperties.$toast.info('Started Profiler for all devices.')
      }
    }
  }

</script>

<style scoped>

</style>
